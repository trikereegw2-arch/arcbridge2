(function(){"use strict";const Kn=["selfBuffs","groupBuffs","squadBuffs"],zn=o=>o!=null&&o.classification?o.classification==="Boon":!0,Gn=o=>`b${o}`,It=(o,s)=>{const r=Array.isArray(o==null?void 0:o.activeTimes)?o.activeTimes:[],h=typeof r[0]=="number"?r[0]:0;return h>0?h:s},yn=(o,s,r,h,k,S,z)=>{const A=o==="selfBuffs"?1:Math.max(o==="groupBuffs"?S-1:z-1,0);return!A||!k?{generationMs:0,wastedMs:0}:s?{generationMs:r*k*A,wastedMs:h*k*A}:{generationMs:r/100*k*A,wastedMs:h/100*k*A}},Pt=o=>{const s=new Map,r=new Map;return o.forEach(S=>{const z=S.details;if(!z)return;const A=z.durationMS||0,G=z.buffMap||{};Object.entries(G).forEach(([D,w])=>{if(!s.has(D)){s.set(D,w);return}const y=s.get(D)||{},C={name:y.name||w.name,stacking:y.stacking??w.stacking,icon:y.icon||w.icon,classification:y.classification||w.classification};s.set(D,C)});const Be=(z.players||[]).filter(D=>!D.notInSquad),ee=Be.length,Q=new Map;Be.forEach(D=>{const w=D.group??0;Q.set(w,(Q.get(w)||0)+1)}),Be.forEach(D=>{const w=D.account||D.name||D.character_name||"Unknown",y=D.profession||"Unknown",C=D.group??0,O=Q.get(C)||1,$=It(D,A);r.has(w)||r.set(w,{account:w,profession:y,professions:new Set,professionTimeMs:{},activeTimeMs:0,numFights:0,groupSupported:0,squadSupported:0,boons:{}});const R=r.get(w);R.profession=y,y!=="Unknown"&&(R.professions.add(y),R.professionTimeMs[y]=(R.professionTimeMs[y]||0)+$),R.activeTimeMs+=$,R.numFights+=1,R.groupSupported+=O,R.squadSupported+=ee,Kn.forEach(ne=>{(D[ne]||[]).forEach(j=>{var be,ve,ge,Ve;if(typeof(j==null?void 0:j.id)!="number")return;const Te=Gn(j.id),pe=G[Te];if(!zn(pe))return;const se=(pe==null?void 0:pe.stacking)??!1,Ee=((ve=(be=j.buffData)==null?void 0:be[0])==null?void 0:ve.generation)??0,te=((Ve=(ge=j.buffData)==null?void 0:ge[0])==null?void 0:Ve.wasted)??0,{generationMs:ae,wastedMs:Ne}=yn(ne,se,Ee,te,A,O,ee);!ae&&!Ne||(s.has(Te)||s.set(Te,pe||{}),R.boons[Te]||(R.boons[Te]={selfBuffs:{generationMs:0,wastedMs:0},groupBuffs:{generationMs:0,wastedMs:0},squadBuffs:{generationMs:0,wastedMs:0}}),R.boons[Te][ne].generationMs+=ae,R.boons[Te][ne].wastedMs+=Ne)})})})}),{boonTables:Array.from(s.keys()).filter(S=>zn(s.get(S))).map(S=>{const z=s.get(S)||{},A=[];return r.forEach(G=>{var D;const we=G.boons[S];if(!we||!Kn.some(w=>we[w].generationMs>0||we[w].wastedMs>0))return;const ee=Array.from(G.professions||[]).filter(w=>w&&w!=="Unknown");let Q=G.profession;if(ee.length>0){Q=ee[0];let w=((D=G.professionTimeMs)==null?void 0:D[Q])||0;ee.forEach(y=>{var O;const C=((O=G.professionTimeMs)==null?void 0:O[y])||0;C>w&&(w=C,Q=y)})}A.push({account:G.account,profession:Q||"Unknown",professionList:ee,activeTimeMs:G.activeTimeMs||1,numFights:G.numFights||1,groupSupported:G.groupSupported||1,squadSupported:G.squadSupported||1,categories:{selfBuffs:{...we.selfBuffs},groupBuffs:{...we.groupBuffs},squadBuffs:{...we.squadBuffs}}})}),{id:S,name:z.name||S,icon:z.icon,stacking:z.stacking??!1,rows:A}}).filter(S=>S.rows.length>0)}},Jn=(o,s,r,h,k,S,z={})=>{var D,w,y,C;const G=((o==null?void 0:o[s])||[]).find(O=>O.id===r);if(!G)return{generationMs:0,wastedMs:0};const we=z[Gn(r)],Be=(we==null?void 0:we.stacking)??!1,ee=((w=(D=G.buffData)==null?void 0:D[0])==null?void 0:w.generation)??0,Q=((C=(y=G.buffData)==null?void 0:y[0])==null?void 0:C.wasted)??0;return yn(s,Be,ee,Q,h,k,S)};var Ut={methods:{tiered:{tiers:{shortMs:500,mediumMs:1500,weights:{short:.5,medium:1,long:2}}}}};const Lt=Ut,In="count",Ht=o=>(o||0)/1e3,_t=(o,s)=>{var k;if(!o)return 0;const r=(k=Lt.methods.tiered)==null?void 0:k.tiers;if(!r)return o;const h=s/Math.max(o,1);return h<=r.shortMs?o*r.weights.short:h<=r.mediumMs?o*r.weights.medium:o*r.weights.long},Yn=(o,s,r)=>r==="duration"?Ht(s):r==="tiered"?_t(o,s):o;function Ot(o,s=In){var S;const r=(S=o.statsAll)==null?void 0:S[0],h=Number((r==null?void 0:r.appliedCrowdControl)??0),k=Number((r==null?void 0:r.appliedCrowdControlDuration)??0);return Yn(h,k,s)}function $t(o,s){const r=(s==null?void 0:s.durationMS)||0,h=(s==null?void 0:s.buffMap)||{},k=o.filter(A=>!A.notInSquad),S=k.length,z=new Map;k.forEach(A=>{const G=A.group??0;z.set(G,(z.get(G)||0)+1)}),k.forEach(A=>{const G=z.get(A.group??0)||1,we=Jn(A,"selfBuffs",1122,r,G,S,h),Be=Jn(A,"squadBuffs",1122,r,G,S,h);A.stabGeneration=(we.generationMs+Be.generationMs)/1e3})}function Rt(o){if(!o.statsTargets)return 0;let s=0;for(const r of o.statsTargets)r&&r.length>0&&(s+=r[0].downContribution||0);return s}function qt(o){if(!o.extBarrierStats||!o.extBarrierStats.outgoingBarrierAllies)return 0;let s=0;for(const r of o.extBarrierStats.outgoingBarrierAllies)if(r)for(const h of r)h&&(s+=h.barrier||0);return s}function xt(o){if(!o.extHealingStats||!o.extHealingStats.outgoingHealingAllies)return 0;let s=0;for(const r of o.extHealingStats.outgoingHealingAllies)if(r)for(const h of r)h&&(s+=h.healing||0);return s}const jt=o=>{var s,r,h,k;return(((r=(s=o.support)==null?void 0:s[0])==null?void 0:r.condiCleanse)||0)+(((k=(h=o.support)==null?void 0:h[0])==null?void 0:k.condiCleanseSelf)||0)},Wt=(o,s=In)=>{var S;const r=(S=o.support)==null?void 0:S[0],h=Number((r==null?void 0:r.boonStrips)??0),k=Number((r==null?void 0:r.boonStripsTime)??0);return Yn(h,k,s)},Vt=o=>Rt(o),Kt=o=>xt(o),zt=o=>qt(o),Gt=(o,s=In)=>Ot(o,s),yt=(o,s)=>$t(o,s),Jt="count",Yt={downContribution:1,healing:1,cleanses:1,strips:1,stability:1,cc:.7,revives:.7,distanceToTag:.7,participation:.7,dodging:.4,dps:.2,damage:.2},Qt={showMvp:!0,topSkillDamageSource:"target",topSkillsMetric:"damage"},Qn=new Map([["bleeding","Bleeding"],["burning","Burning"],["confusion","Confusion"],["poison","Poison"],["torment","Torment"],["vulnerability","Vulnerability"],["weakness","Weakness"],["weakened","Weakness"],["blind","Blind"],["blinded","Blind"],["blinding","Blind"],["cripple","Cripple"],["crippled","Cripple"],["chill","Chill"],["chilled","Chill"],["immob","Immobilize"],["immobile","Immobilize"],["immobilized","Immobilize"],["slow","Slow"],["slowed","Slow"],["fear","Fear"],["feared","Fear"],["taunt","Taunt"],["taunted","Taunt"]]),Xt={Blind:"https://render.guildwars2.com/file/09770136BB76FD0DBE1CC4267DEED54774CB20F6/102837.png",Chill:"https://render.guildwars2.com/file/28C4EC547A3516AF0242E826772DA43A5EAC3DF3/102839.png",Cripple:"https://render.guildwars2.com/file/070325E519C178D502A8160523766070D30C0C19/102838.png",Fear:"https://render.guildwars2.com/file/30307A6E766D74B6EB09EDA12A4A2DE50E4D76F4/102869.png",Immobilize:"https://render.guildwars2.com/file/397A613651BFCA2832B6469CE34735580A2C120E/102844.png",Slow:"https://render.guildwars2.com/file/F60D1EF5271D7B9319610855676D320CD25F01C6/961397.png",Taunt:"https://render.guildwars2.com/file/02EED459AD65FAF7DF32A260E479C625070841B9/1228472.png",Vulnerability:"https://render.guildwars2.com/file/3A394C1A0A3257EB27A44842DDEEF0DF000E1241/102850.png",Weakness:"https://render.guildwars2.com/file/6CB0E64AF9AA292E332A38C1770CE577E2CDE0E8/102853.png"},ln=o=>{if(!o)return null;const s=o.trim().toLowerCase(),r=Qn.get(s);if(r)return r;const h=s.split(/[^a-z]+/).filter(Boolean);for(const k of h){const S=Qn.get(k);if(S)return S}return null},Zt=o=>ln(o),Xn=o=>{const s=new Map;return o&&(Object.values(o).forEach(r=>{if(!(r!=null&&r.icon)||!(r!=null&&r.name))return;const h=ln(r.name);h&&(s.has(h)||s.set(h,r.icon))}),Object.entries(Xt).forEach(([r,h])=>{s.has(r)||s.set(r,h)})),s},Cn=(o,s,r)=>{var h;if(s&&r){const k=(h=r[`b${s}`])==null?void 0:h.name,S=ln(k);if(S)return S}return o?ln(o):null},eo=o=>{const s=(o==null?void 0:o.account)||"Unknown";return s&&s!=="Unknown"?s:(o==null?void 0:o.name)||"Unknown"||null},no=o=>{if(!o||o.length===0)return 0;let s=0,r=null;return o.forEach(h=>{const k=Number(h[1]??0);if(Number.isFinite(k)){if(r===null){r=k;return}k>r&&(s+=k-r),r=k}}),s},to=o=>{if(!o||o.length===0)return 0;let s=0;return o.forEach(r=>{const h=Number(r[0]??0),k=Number(r[1]??0);Number.isFinite(k)&&h!==0&&k>0&&(s+=1)}),s},oo=o=>{const{players:s,targets:r,skillMap:h,buffMap:k}=o,S=o.getPlayerKey||eo,z=Xn(k),A={},G={};s.forEach(D=>{if(D!=null&&D.notInSquad)return;const w=S(D);w&&(A[w]||(A[w]={}),D!=null&&D.totalDamageDist&&D.totalDamageDist.forEach(y=>{y&&y.forEach(C=>{if(!C.id)return;let O=`Skill ${C.id}`,$;h&&(h[`s${C.id}`]?(O=h[`s${C.id}`].name||O,$=h[`s${C.id}`].icon||$):h[`${C.id}`]&&(O=h[`${C.id}`].name||O,$=h[`${C.id}`].icon||$));const R=Cn(O,C.id,k);if(!R)return;const ne=k==null?void 0:k[`b${C.id}`],Ae=ne==null?void 0:ne.name,j=z.get(R)||(ne==null?void 0:ne.icon),Te=O.startsWith("Skill ")?Ae||R:O,pe=$||(ne==null?void 0:ne.icon),se=Number(C.connectedHits??0),Ee=Number(C.hits??0),te=se>0?se:Ee,ae=Number(C.totalDamage??0);if(!Number.isFinite(te)&&!Number.isFinite(ae))return;const Ne=G[R]||{name:R,icon:j,applications:0,damage:0};Ne.applications+=Number.isFinite(te)?te:0,Ne.damage+=Number.isFinite(ae)?ae:0,!Ne.icon&&j&&(Ne.icon=j),G[R]=Ne;const be=A[w][R]||{icon:j,applications:0,damage:0,skills:{}};be.applications+=Number.isFinite(te)?te:0,be.damage+=Number.isFinite(ae)?ae:0;const ve=be.skills[Te]||{name:Te,hits:0,damage:0,icon:pe};ve.hits+=Number.isFinite(te)?te:0,ve.damage+=Number.isFinite(ae)?ae:0,!ve.icon&&pe&&(ve.icon=pe),be.skills[Te]=ve,!be.icon&&j&&(be.icon=j),A[w][R]=be})}))});const we=new Map;s.forEach(D=>{if(D!=null&&D.notInSquad)return;const w=S(D);w&&D!=null&&D.name&&we.set(D.name,w)});let Be=0,ee=0,Q=0;return r.forEach(D=>{D!=null&&D.buffs&&D.buffs.forEach(w=>{const y=Number(w==null?void 0:w.id);if(!Number.isFinite(y))return;const C=k==null?void 0:k[`b${y}`],O=ln(C==null?void 0:C.name);if(!O||C!=null&&C.classification&&C.classification!=="Condition")return;const $=O;if(!$)return;const R=w.statesPerSource||{};Q+=1,Object.entries(R).forEach(([ne,Ae])=>{var te;const j=we.get(ne);if(!j)return;ee+=1;const Te=no(Ae),pe=to(Ae);Be+=Te;const se=((te=A[j])==null?void 0:te[$])||{applications:0,damage:0,skills:{}};se.applicationsFromBuffs=(se.applicationsFromBuffs||0)+Te,se.applicationsFromBuffsActive=(se.applicationsFromBuffsActive||0)+pe,A[j]=A[j]||{},A[j][$]=se;const Ee=G[$]||{name:$,applications:0,damage:0};Ee.applicationsFromBuffs=(Ee.applicationsFromBuffs||0)+Te,Ee.applicationsFromBuffsActive=(Ee.applicationsFromBuffsActive||0)+pe,G[$]=Ee})})}),Object.values(A).forEach(D=>{Object.values(D).forEach(w=>{typeof w.applicationsFromBuffs=="number"&&(w.applications=w.applicationsFromBuffs)})}),Object.values(G).forEach(D=>{typeof D.applicationsFromBuffs=="number"&&(D.applications=D.applicationsFromBuffs)}),{playerConditions:A,summary:G,meta:{buffStateApplicationsTotal:Be,targetBuffEntriesSeen:Q,buffStateSourcesSeen:ee}}},io=new Set(["Vulnerability","Weakness","Blind","Cripple","Chill","Immobilize","Slow","Fear","Taunt"]),so=[{id:"damage",label:"Damage",field:"damage",source:"dpsAll"},{id:"directDmg",label:"Direct Damage",field:"directDmg",source:"statsTargets"},{id:"connectedDamageCount",label:"Connected Damage Count",field:"connectedDamageCount",source:"statsTargets"},{id:"connectedDirectDamageCount",label:"Connected Direct Damage Count",field:"connectedDirectDamageCount",source:"statsTargets"},{id:"battleStandardHits",label:"Battle Standard Tracking"},{id:"criticalRate",label:"Critical Rate",field:"criticalRate",isRate:!0,isPercent:!0,denomField:"critableDirectDamageCount",source:"statsTargets"},{id:"criticalDmg",label:"Critical Damage",field:"criticalDmg",source:"statsTargets"},{id:"flankingRate",label:"Flanking Rate",field:"flankingRate",isRate:!0,isPercent:!0,denomField:"connectedDirectDamageCount",source:"statsTargets"},{id:"glanceRate",label:"Glance Rate",field:"glanceRate",isRate:!0,isPercent:!0,denomField:"connectedDirectDamageCount",source:"statsTargets"},{id:"missed",label:"Missed",field:"missed",source:"statsTargets"},{id:"evaded",label:"Evaded (enemy)",field:"evaded",source:"statsTargets"},{id:"blocked",label:"Blocked (enemy)",field:"blocked",source:"statsTargets"},{id:"interrupts",label:"Interrupts",field:"interrupts",source:"statsTargets"},{id:"invulned",label:"Invulned",field:"invulned",source:"statsTargets"},{id:"killed",label:"Killed",field:"killed",source:"statsTargets"},{id:"downed",label:"Downed",field:"downed",source:"statsTargets"},{id:"downContribution",label:"Down Contribution",field:"downContribution",source:"statsTargets"},{id:"downContributionPercent",label:"Down Contribution %",isRate:!0,isPercent:!0},{id:"againstDownedDamage",label:"Against Downed Damage",field:"againstDownedDamage",source:"statsTargets"},{id:"appliedCrowdControl",label:"Applied CC",field:"appliedCrowdControl",source:"statsTargets"},{id:"appliedCrowdControlDuration",label:"Applied CC Duration",field:"appliedCrowdControlDuration",source:"statsTargets"},{id:"appliedCrowdControlDownContribution",label:"Applied CC Down Contribution",field:"appliedCrowdControlDownContribution",source:"statsTargets"},{id:"appliedCrowdControlDurationDownContribution",label:"Applied CC Duration Down Contribution",field:"appliedCrowdControlDurationDownContribution",source:"statsTargets"},{id:"boonStrips",label:"Boon Strips",field:"boonStrips",source:"support"}],ao=[{id:"damageTaken",label:"Damage Taken",field:"damageTaken"},{id:"damageTakenCount",label:"Damage Taken Count",field:"damageTakenCount"},{id:"conditionDamageTaken",label:"Condition Damage Taken",field:"conditionDamageTaken"},{id:"conditionDamageTakenCount",label:"Condition Damage Taken Count",field:"conditionDamageTakenCount"},{id:"powerDamageTaken",label:"Power Damage Taken",field:"powerDamageTaken"},{id:"powerDamageTakenCount",label:"Power Damage Taken Count",field:"powerDamageTakenCount"},{id:"downedDamageTaken",label:"Downed Damage Taken",field:"downedDamageTaken"},{id:"downedDamageTakenCount",label:"Downed Damage Taken Count",field:"downedDamageTakenCount"},{id:"damageBarrier",label:"Damage Barrier",field:"damageBarrier"},{id:"damageBarrierCount",label:"Damage Barrier Count",field:"damageBarrierCount"},{id:"blockedCount",label:"Blocked Count",field:"blockedCount"},{id:"evadedCount",label:"Evaded Count",field:"evadedCount"},{id:"missedCount",label:"Missed Count",field:"missedCount"},{id:"dodgeCount",label:"Dodge Count",field:"dodgeCount"},{id:"invulnedCount",label:"Invulnerable Count",field:"invulnedCount"},{id:"interruptedCount",label:"Interrupted Count",field:"interruptedCount"},{id:"downCount",label:"Down Count",field:"downCount"},{id:"deadCount",label:"Death Count",field:"deadCount"},{id:"boonStrips",label:"Boon Strips (Incoming)",field:"boonStrips"},{id:"conditionCleanses",label:"Cleanses (Incoming)",field:"conditionCleanses"},{id:"receivedCrowdControl",label:"Crowd Control (Incoming)",field:"receivedCrowdControl"}],ro=[{id:"condiCleanse",label:"Condition Cleanses",field:"condiCleanse"},{id:"condiCleanseTime",label:"Condition Cleanse Time",field:"condiCleanseTime",isTime:!0},{id:"condiCleanseSelf",label:"Condition Cleanse Self",field:"condiCleanseSelf"},{id:"condiCleanseTimeSelf",label:"Condition Cleanse Time Self",field:"condiCleanseTimeSelf",isTime:!0},{id:"boonStrips",label:"Boon Strips",field:"boonStrips"},{id:"boonStripsTime",label:"Boon Strips Time",field:"boonStripsTime",isTime:!0},{id:"boonStripDownContribution",label:"Boon Strip Down Contribution",field:"boonStripDownContribution"},{id:"boonStripDownContributionTime",label:"Boon Strip Down Contribution Time",field:"boonStripDownContributionTime",isTime:!0},{id:"stunBreak",label:"Stun Breaks",field:"stunBreak"},{id:"removedStunDuration",label:"Removed Stun Duration",field:"removedStunDuration",isTime:!0},{id:"resurrects",label:"Resurrects",field:"resurrects"},{id:"resurrectTime",label:"Resurrect Time",field:"resurrectTime",isTime:!0}],co=["battle standard","glyph of renewal","glyph of the stars","illusion of life","spirit of nature","nature spirit","search and rescue","signet of mercy"],lo=new Set([10244]),uo=(o,s)=>{var k;if(lo.has(o))return!0;const r=(s==null?void 0:s[`s${o}`])||(s==null?void 0:s[`${o}`]),h=((k=r==null?void 0:r.name)==null?void 0:k.toLowerCase())||"";return co.some(S=>h.includes(S))},fo=o=>{if(!o||!Number.isFinite(o))return"--:--";const s=Math.max(0,Math.round(o/1e3)),r=Math.floor(s/3600),h=Math.floor(s%3600/60),k=s%60;return r>0?`${r}:${String(h).padStart(2,"0")}:${String(k).padStart(2,"0")}`:`${h}:${String(k).padStart(2,"0")}`},Dn={Guardian:"#72C1D9",Dragonhunter:"#72C1D9",Firebrand:"#72C1D9",Willbender:"#72C1D9",Revenant:"#D16E5A",Herald:"#D16E5A",Renegade:"#D16E5A",Vindicator:"#D16E5A",Warrior:"#FFD166",Berserker:"#FFD166",Spellbreaker:"#FFD166",Bladesworn:"#FFD166",Engineer:"#D09C59",Scrapper:"#D09C59",Holosmith:"#D09C59",Mechanist:"#D09C59",Ranger:"#8CDC82",Druid:"#8CDC82",Soulbeast:"#8CDC82",Untamed:"#8CDC82",Thief:"#C08F95",Daredevil:"#C08F95",Deadeye:"#C08F95",Specter:"#C08F95",Elementalist:"#F68A87",Tempest:"#F68A87",Weaver:"#F68A87",Catalyst:"#F68A87",Mesmer:"#B679D5",Chronomancer:"#B679D5",Mirage:"#B679D5",Virtuoso:"#B679D5",Necromancer:"#52A76F",Reaper:"#52A76F",Scourge:"#52A76F",Harbinger:"#52A76F",Ritualist:"#52A76F",Luminary:"#72C1D9",Conduit:"#D16E5A",Paragon:"#FFD166",Amalgam:"#D09C59",Galeshot:"#8CDC82",Antiquary:"#C08F95",Evoker:"#F68A87",Troubadour:"#B679D5",Unknown:"#64748B"};function Zn(o){return Dn[o]||Dn.Unknown}const mo=o=>{if(o==null||o==="")return 0;if(typeof o=="number")return!Number.isFinite(o)||o<=0?0:o>1e12?o:o*1e3;if(o instanceof Date){const z=o.getTime();return Number.isFinite(z)&&z>0?z:0}const s=String(o).trim();if(!s)return 0;const r=Number(s);if(Number.isFinite(r)&&r>0)return r>1e12?r:r*1e3;const h=Date.parse(s);if(Number.isFinite(h)&&h>0)return h;const k=s.replace(/([+-]\d{2})$/,"$1:00"),S=Date.parse(k);return Number.isFinite(S)&&S>0?S:0},nn=(o,s)=>mo((o==null?void 0:o.uploadTime)??(s==null?void 0:s.uploadTime)??(o==null?void 0:o.timeStartStd)??(o==null?void 0:o.timeStart)??(o==null?void 0:o.timeEndStd)??(o==null?void 0:o.timeEnd)??(o==null?void 0:o.timeStartText)??(o==null?void 0:o.timeEndText)),go=({logs:o,precomputedStats:s,mvpWeights:r,statsViewSettings:h,disruptionMethod:k})=>{const S=(()=>{const ee=o.filter(Q=>Q.details&&Q.details.players&&Q.details.players.length>0);return console.log("[useStatsAggregation] Filtering logs:",{total:o.length,passed:ee.length,statuses:o.map(Q=>Q.status),hasDetails:o.map(Q=>!!Q.details)}),ee})(),z=h||Qt,A=r||Yt,G=ee=>{if(!ee||typeof ee!="object")return ee;const Q=Array.isArray(ee.fightBreakdown)?ee.fightBreakdown:null;if(!Q||Q.length===0)return ee;const D=new Map,w=new Map;o.forEach(C=>{var R;const O=(C==null?void 0:C.filePath)||(C==null?void 0:C.id);O&&D.set(String(O),C);const $=(C==null?void 0:C.permalink)||((R=C==null?void 0:C.details)==null?void 0:R.permalink);typeof $=="string"&&$.trim()&&w.set($.trim(),C)});const y=Q.map(C=>{if(!C||typeof C!="object"||Number(C.timestamp)>0)return C;const $=C.id?String(C.id):"",R=typeof C.permalink=="string"?C.permalink.trim():"",ne=($?D.get($):void 0)||(R?w.get(R):void 0);if(!ne)return C;const Ae=nn(ne==null?void 0:ne.details,ne);return Ae?{...C,timestamp:Ae}:C});return{...ee,fightBreakdown:y}},we=(()=>{if(s)return G(s);const ee=k||Jt,Q=z.topSkillDamageSource||"target",D=z.topSkillsMetric||"damage",w=S.length;let y=0,C=0,O=0,$=0,R=0,ne=0,Ae=0,j=0;const Te=e=>{const t=((e==null?void 0:e.players)||[]).filter(F=>!F.notInSquad);let l=0,a=0,m=0,b=0;return t.forEach(F=>{var ue;const B=(ue=F.defenses)==null?void 0:ue[0];if(!B)return;const me=Number(B.downCount||0),Me=Number(B.deadCount||0);l+=me+Me,m+=Me}),t.forEach(F=>{!F.statsTargets||F.statsTargets.length===0||F.statsTargets.forEach(B=>{const me=B==null?void 0:B[0];if(!me)return;const Me=Number(me.downed||0),ue=Number(me.killed||0);a+=Me+ue,b+=ue})}),{squadDownsDeaths:l,enemyDownsDeaths:a,squadDeaths:m,enemyDeaths:b}},pe=e=>{const{squadDownsDeaths:n,enemyDownsDeaths:t}=Te(e);return n>0||t>0?t>n:typeof(e==null?void 0:e.success)=="boolean"?e.success:!1},se=new Map,Ee=new Set(["boonStripsTime","condiCleanseTime","condiCleanseTimeSelf"]),te={},ae={},Ne=new Map,be={},ve={},ge={},Ve=new Map,je=new Map,Tn=new Set(Object.keys(Dn)),kn=Object.keys(Dn).filter(e=>e&&e!=="Unknown").sort((e,n)=>n.length-e.length),Sn=["Guardian","Revenant","Warrior","Engineer","Ranger","Thief","Elementalist","Mesmer","Necromancer"],on=e=>{if(!e)return"Unknown";const n=String(e).replace(/\s*\([^)]*\)\s*$/,"").replace(/\s*\[[^\]]*\]\s*$/,"").replace(/\s\d+$/,"").trim();if(Tn.has(n))return n;const t=n.toLowerCase();for(const a of kn)if(t.includes(a.toLowerCase()))return a;return Sn.find(a=>t.includes(a.toLowerCase()))||n||"Unknown"},bo=e=>e!=null&&e.classification?e.classification==="Boon":!0,vn=new Map,wn=new Map,un=()=>({totalHits:0,blocked:0,evaded:0,glanced:0,missed:0,invulned:0,interrupted:0,totalMitigation:0,minMitigation:0}),H=e=>{const n=Number(e);return Number.isFinite(n)?n:0},st=e=>{const n=String(e).split("|"),t=n[0]||"Unknown",l=on(n[1]||"Unknown"),a=n[2]||t||"Unknown";return{name:t,profession:l,account:a}},at=(e,n,t)=>{let l=e.get(n);return l?t.profession&&!l.professionList.includes(t.profession)&&l.professionList.push(t.profession):(l={account:t.account,name:t.name,profession:t.profession,professionList:t.profession?[t.profession]:[],activeMs:0,mitigationTotals:un()},e.set(n,l)),l},rt=(e,n,t)=>{let l=e.get(n);return l?t.profession&&!l.professionList.includes(t.profession)&&l.professionList.push(t.profession):(l={account:t.account,name:t.name,profession:t.profession,professionList:t.profession?[t.profession]:[],activeMs:0,mitigationTotals:un(),minion:t.minion},e.set(n,l)),l},ct=(e,n)=>{e.totalHits+=H((n==null?void 0:n.skill_hits)??(n==null?void 0:n.skillHits)),e.blocked+=H(n==null?void 0:n.blocked),e.evaded+=H(n==null?void 0:n.evaded),e.glanced+=H(n==null?void 0:n.glanced),e.missed+=H(n==null?void 0:n.missed),e.invulned+=H(n==null?void 0:n.invulned),e.interrupted+=H(n==null?void 0:n.interrupted),e.totalMitigation+=H((n==null?void 0:n.avoided_damage)??(n==null?void 0:n.avoidedDamage)),e.minMitigation+=H((n==null?void 0:n.min_avoided_damage)??(n==null?void 0:n.minAvoidedDamage))},ho=e=>Object.values(e).some(n=>n>0);console.log("[useStatsAggregation] Starting aggregation loop",{validLogsCount:S.length});const Mn=(e,n,t)=>{var m,b,F,B;const l=`s${e}`;if((m=n==null?void 0:n[l])!=null&&m.name)return n[l].name;if((b=n==null?void 0:n[String(e)])!=null&&b.name)return n[String(e)].name;const a=`b${e}`;return(F=t==null?void 0:t[a])!=null&&F.name?t[a].name:(B=t==null?void 0:t[String(e)])!=null&&B.name?t[String(e)].name:`Unknown Skill ${e}`},dn=new Map,Qe=e=>{const n=dn.get(e);if(!n)return{hasSkill:!1,avg:1,min:1,hits:0};const t=n.connectedHits||0,l=t>0?n.totalDamage/t:0,a=n.minCount>0?n.minTotal/n.minCount:0;return{hasSkill:!0,avg:l,min:a,hits:t}},An="Ashtonlightstone.9145",lt="Illusionary Warden",Ln=[],Xe=[],Hn=[],_n=[],ut=new Map,dt=new Map,ft=(e,n,t)=>{const l=e.get(n)||un();return l.totalHits+=t.totalHits,l.blocked+=t.blocked,l.evaded+=t.evaded,l.glanced+=t.glanced,l.missed+=t.missed,l.invulned+=t.invulned,l.interrupted+=t.interrupted,e.set(n,l),l};S.forEach(e=>{const n=e.details;if(!n)return;(n.targets||[]).forEach(l=>{const a=(l==null?void 0:l.totalDamageDist)||[],m=Array.isArray(a)?a[0]:null;m==null||m.forEach(b=>{if(!(b!=null&&b.id))return;const F=Number(b.id),B=dn.get(F)||{totalDamage:0,connectedHits:0,minTotal:0,minCount:0};B.totalDamage+=Number(b.totalDamage||0),B.connectedHits+=Number(b.connectedHits||0);const me=Number.isFinite(Number(b.min))?Number(b.min):0;B.minTotal+=me,B.minCount+=1,dn.set(F,B)})})}),S.forEach((e,n)=>{var Tt,kt;const t=e.details;if(!t)return;const l=t.players;console.log(`[useStatsAggregation] Processing log ${n}:`,{playerCount:l==null?void 0:l.length,hasTargets:!!t.targets,firstPlayer:l!=null&&l[0]?{account:l[0].account,notInSquad:l[0].notInSquad}:"none"});const a=t.targets||[],m=t.skillMap||{},b=t.buffMap||{},F=new Map,B=new Map;a.forEach(i=>{const f=(i==null?void 0:i.totalDamageDist)||[],T=Array.isArray(f)?f[0]:null;T==null||T.forEach(U=>{var W;if(!(U!=null&&U.id))return;const M=Number(U.id),p=((W=m==null?void 0:m[M])==null?void 0:W.name)||U.name||U.skillName||String(M),_=F.get(M)||{totalDamage:0,connectedHits:0,minTotal:0,minCount:0};_.totalDamage+=Number(U.totalDamage||0),_.connectedHits+=Number(U.connectedHits||0);const v=Number.isFinite(Number(U.min))?Number(U.min):0;_.minTotal+=v,_.minCount+=1,F.set(M,_);const I=B.get(p)||{totalDamage:0,connectedHits:0,minTotal:0,minCount:0};I.totalDamage+=Number(U.totalDamage||0),I.connectedHits+=Number(U.connectedHits||0);const ce=Number.isFinite(Number(U.min))?Number(U.min):0;I.minTotal+=ce,I.minCount+=1,B.set(p,I)})});const me=i=>{const f=F.get(i);if(!f||f.connectedHits<=0)return{avg:1,min:1};const T=f.connectedHits>0?f.totalDamage/f.connectedHits:0,U=f.minCount>0?f.minTotal/f.minCount:T;return{avg:T||1,min:U||1}},Me=i=>{const f=B.get(i);if(!f||f.connectedHits<=0)return{avg:1,min:1};const T=f.connectedHits>0?f.totalDamage/f.connectedHits:0,U=f.minCount>0?f.minTotal/f.minCount:T;return{avg:T||1,min:U||1}},ue=t.combatReplayMetaData||{},$e=(ue==null?void 0:ue.inchToPixel)>0?ue.inchToPixel:1,Pe=(ue==null?void 0:ue.pollingRate)>0?ue.pollingRate:1,ke=5e3,De=i=>Array.isArray(i)?i.map(f=>Array.isArray(f)?[Number(f[0]),Number(f[1])]:null).filter(f=>!!f&&Number.isFinite(f[0])):[];let Re=[],qe=t.durationMS||0,sn=!1;const xe=l.find(i=>(i==null?void 0:i.hasCommanderTag)&&!(i!=null&&i.notInSquad));(Tt=xe==null?void 0:xe.combatReplayData)!=null&&Tt.positions&&(Re=xe.combatReplayData.positions,De(xe.combatReplayData.dead).forEach(([f])=>{f>0&&(sn=!0,qe=Math.min(qe,f))}));const jn=i=>{var I;const f=(I=i.statsAll)==null?void 0:I[0];if((f==null?void 0:f.distToCom)!==void 0&&(f==null?void 0:f.distToCom)!=="Infinity")return Math.round(Number(f.distToCom));if((f==null?void 0:f.stackDist)!==void 0)return Math.round(Number(f.stackDist))||0;if(i.hasCommanderTag)return 0;const T=i.combatReplayData;if(!(T!=null&&T.positions)||!Re.length)return 0;const U=T.positions,M=De(T.dead),p=De(T.down),_=Math.floor((T.start||0)/Pe);let v=0;if(M.length&&p.length)for(const[ce]of M){if(ce<0)continue;const W=Math.max(0,Math.floor(ce/Pe))-_;for(const[N,V]of p){if(ce!==V)continue;const L=sn&&N>qe?Math.max(1,Math.floor(qe/Pe)):W,ie=Math.max(0,Math.min(L,U.length,Re.length));if(ie<=0)continue;let x=0;for(let de=0;de<ie;de++){const[E,Z]=U[de],[Y,K]=Re[de];x+=Math.hypot(E-Y,Z-K)}v=Math.round(x/ie/$e)}}return v},an=l.filter(i=>!i.notInSquad),Wn=l.filter(i=>i.notInSquad);O+=an.length,$+=a.filter(i=>!i.isFake).length,yt(l,{durationMS:t.durationMS,buffMap:t.buffMap});const{squadDeaths:u,enemyDeaths:X}=Te(t);R+=u,ne+=X,j+=u,Ae+=X,pe(t)?y++:C++;const re=t.skillMap?Number((kt=Object.keys(t.skillMap).find(i=>{var f,T;return((T=(f=t.skillMap)==null?void 0:f[i])==null?void 0:T.name)==="Battle Standard"}))==null?void 0:kt.replace(/^s/,"")):null;l.forEach((i,f)=>{var Ke,ze,Ze,en,Fn,fn,mn,St,vt,wt,Mt,At;if(i.notInSquad)return;const T=i.account||"Unknown",U=T!=="Unknown"?T:i.name||"Unknown",M=i.name||"Unknown";se.has(U)||se.set(U,{name:M,account:U,downContrib:0,cleanses:0,strips:0,stab:0,healing:0,barrier:0,cc:0,logsJoined:0,totalDist:0,distCount:0,dodges:0,downs:0,deaths:0,totalFightMs:0,offenseTotals:{},offenseRateWeights:{},defenseActiveMs:0,defenseTotals:{},supportActiveMs:0,supportTotals:{},healingActiveMs:0,healingTotals:{},profession:i.profession||"Unknown",professions:new Set,professionTimeMs:{},isCommander:!1,damage:0,dps:0,revives:0,outgoingConditions:{},incomingConditions:{}});const p=se.get(U);if(i.hasCommanderTag&&(p.isCommander=!0),i.profession&&i.profession!=="Unknown"){p.profession=i.profession,p.professions.add(i.profession);const c=Array.isArray(i.activeTimes)&&typeof i.activeTimes[0]=="number"?i.activeTimes[0]:t.durationMS||0;p.professionTimeMs[i.profession]=(p.professionTimeMs[i.profession]||0)+c}p.logsJoined++,p.downContrib+=Vt(i),p.cleanses+=jt(i),p.strips+=Wt(i,ee),p.healing+=Kt(i),p.barrier+=zt(i),p.cc+=Gt(i,ee),p.stab+=i.stabGeneration||0;const _=jn(i);_<=ke&&(p.totalDist+=_,p.distCount++),(Ke=i.defenses)!=null&&Ke[0]&&(p.dodges+=i.defenses[0].dodgeCount||0,p.downs+=i.defenses[0].downCount||0,p.deaths+=i.defenses[0].deadCount||0),t.durationMS&&(p.totalFightMs+=t.durationMS);const v=Array.isArray(i.activeTimes)&&typeof i.activeTimes[0]=="number"?i.activeTimes[0]:t.durationMS||0;p.defenseActiveMs+=v,p.supportActiveMs+=v,p.healingActiveMs+=v,Array.isArray(i.buffUptimes)&&i.buffUptimes.length>0&&i.buffUptimes.forEach(c=>{var Et,Nt,Ft,Bt;if(typeof(c==null?void 0:c.id)!="number")return;const d=`b${c.id}`,g=((Et=t.buffMap)==null?void 0:Et[d])||((Nt=t.buffMap)==null?void 0:Nt[String(c.id)]);if(!g||bo(g))return;const P=Number(((Bt=(Ft=c.buffData)==null?void 0:Ft[0])==null?void 0:Bt.uptime)??0);if(!Number.isFinite(P)||P<=0)return;const he=(g==null?void 0:g.stacking)??!1,Ue=(he?P:P/100)*v;if(!Number.isFinite(Ue)||Ue<=0)return;const Se=Zt(g==null?void 0:g.name);if(Se&&io.has(Se)&&(!(g!=null&&g.classification)||g.classification==="Condition")){const Bn=Ue/1e3,He=g==null?void 0:g.icon,gn=be[Se]||{name:Se,icon:He,applications:0,damage:0};gn.applicationsFromUptime=(gn.applicationsFromUptime||0)+Bn,!gn.icon&&He&&(gn.icon=He),be[Se]=gn;const pn=p.outgoingConditions[Se]||{applications:0,damage:0,skills:{},icon:He};pn.applicationsFromUptime=(pn.applicationsFromUptime||0)+Bn,!pn.icon&&He&&(pn.icon=He),p.outgoingConditions[Se]=pn;const bn=ve[Se]||{name:Se,icon:He,applications:0,damage:0};bn.applicationsFromUptime=(bn.applicationsFromUptime||0)+Bn,!bn.icon&&He&&(bn.icon=He),ve[Se]=bn;const hn=p.incomingConditions[Se]||{applications:0,damage:0,skills:{},icon:He};hn.applicationsFromUptime=(hn.applicationsFromUptime||0)+Bn,!hn.icon&&He&&(hn.icon=He),p.incomingConditions[Se]=hn}Ve.has(d)||Ve.set(d,{name:g==null?void 0:g.name,stacking:he,icon:g==null?void 0:g.icon}),je.has(d)||je.set(d,new Map);const Ye=je.get(d),rn=p.account||i.account||i.name||"Unknown";let ye=Ye.get(rn);ye||(ye={account:rn,profession:p.profession||i.profession||"Unknown",professions:new Set,professionTimeMs:{},totalMs:0,durationMs:0},Ye.set(rn,ye));const cn=i.profession||p.profession;cn&&cn!=="Unknown"&&(ye.professions.add(cn),ye.professionTimeMs[cn]=(ye.professionTimeMs[cn]||0)+v,ye.profession=cn),ye.totalMs+=Ue,ye.durationMs+=v}),(ze=i.defenses)!=null&&ze[0]&&ao.forEach(c=>{const d=Number(i.defenses[0][c.field]??0);Number.isFinite(d)&&(p.defenseTotals[c.id]=(p.defenseTotals[c.id]||0)+d)}),(Ze=i.support)!=null&&Ze[0]&&ro.forEach(c=>{let d=Number(i.support[0][c.field]??0);Number.isFinite(d)&&(Ee.has(c.field)&&d>999999&&(d=0),p.supportTotals[c.id]=(p.supportTotals[c.id]||0)+d)});const I=(c,d)=>{Number.isFinite(d)&&(p.healingTotals[c]=(p.healingTotals[c]||0)+d)},ce=(c,d)=>Array.isArray(c)?c.reduce((g,P)=>g+Number((P==null?void 0:P[d])??0),0):0,W=(c,d,g)=>{if(!Number.isFinite(g)||g<=0)return;const P=l[d],he=d===f,Ge=P==null?void 0:P.notInSquad,Ue=!Ge,Se=Ue&&(P==null?void 0:P.group)!=null&&P.group===i.group;I(c,g),Ue&&I(`squad${c[0].toUpperCase()}${c.slice(1)}`,g),Se&&I(`group${c[0].toUpperCase()}${c.slice(1)}`,g),he&&I(`self${c[0].toUpperCase()}${c.slice(1)}`,g),Ge&&I(`offSquad${c[0].toUpperCase()}${c.slice(1)}`,g)};if(Array.isArray(i.rotation)){let c=0;i.rotation.forEach(d=>{var P;if(!(d!=null&&d.id)||!uo(d.id,t.skillMap))return;const g=((P=d.skills)==null?void 0:P.length)||0;g>0&&(c+=g,I(`resUtility_s${d.id}`,g))}),c>0&&I("resUtility",c)}const N=(en=i.extHealingStats)==null?void 0:en.outgoingHealingAllies;Array.isArray(N)&&N.forEach((c,d)=>{const g=ce(c,"healing"),P=ce(c,"downedHealing");W("healing",d,g),W("downedHealing",d,P)});const V=(Fn=i.extBarrierStats)==null?void 0:Fn.outgoingBarrierAllies;Array.isArray(V)&&V.forEach((c,d)=>{const g=ce(c,"barrier");W("barrier",d,g)});const L=(fn=i.statsAll)==null?void 0:fn[0],ie=(mn=i.dpsAll)==null?void 0:mn[0],x=(St=i.support)==null?void 0:St[0];if(so.forEach(c=>{if(c.id==="downContributionPercent"||!c.field)return;let d=0,g=0;c.source==="dpsAll"&&ie?d=Number(ie[c.field]??0):c.source==="statsAll"&&L?(d=Number(L[c.field]??0),g=Number(L[c.denomField||c.weightField||"connectedDamageCount"]??0)):c.source==="support"&&x?d=Number(x[c.field]??0):i.statsTargets&&i.statsTargets.forEach(P=>{P!=null&&P[0]&&(d+=Number(P[0][c.field]??0),g+=Number(P[0][c.denomField||c.weightField||"connectedDamageCount"]??0))}),Number.isFinite(d)&&(p.offenseTotals[c.id]=(p.offenseTotals[c.id]||0)+d,c.isRate&&g>0&&(p.offenseRateWeights[c.id]=(p.offenseRateWeights[c.id]||0)+g))}),i.targetDamageDist&&Number.isFinite(re)){const c=i.targetDamageDist.flatMap(d=>d||[]).flatMap(d=>d||[]).reduce((d,g)=>g!=null&&g.id&&g.id===re?d+((g==null?void 0:g.connectedHits)||0):d,0);p.offenseTotals.battleStandardHits=(p.offenseTotals.battleStandardHits||0)+c}p.revives+=((wt=(vt=i.support)==null?void 0:vt[0])==null?void 0:wt.resurrects)||0,ie&&(p.damage+=ie.damage||0,p.dps+=ie.dps||0);const de=c=>{var he,Ge,Ue,Se;let d=`Skill ${c.id}`;const g=((he=t.skillMap)==null?void 0:he[`s${c.id}`])||((Ge=t.skillMap)==null?void 0:Ge[`${c.id}`]);let P=g==null?void 0:g.icon;if(g!=null&&g.name&&(d=g.name),d.startsWith("Skill ")){const Ye=Cn(d,c.id,t.buffMap);Ye&&(d=Ye,P=((Se=(Ue=t.buffMap)==null?void 0:Ue[`b${c.id}`])==null?void 0:Se.icon)||P)}return{name:d,icon:P}},E=c=>{if(!(c!=null&&c.id))return;const{name:d,icon:g}=de(c);te[c.id]||(te[c.id]={name:d,icon:g,damage:0,hits:0,downContribution:0}),te[c.id].name.startsWith("Skill ")&&!d.startsWith("Skill ")&&(te[c.id].name=d),!te[c.id].icon&&g&&(te[c.id].icon=g),te[c.id].damage+=c.totalDamage,te[c.id].hits+=c.connectedHits,te[c.id].downContribution+=Number(c.downContribution||0)},Z=i.account||i.name||"Unknown",Y=i.profession||"Unknown",K=`${Z}|${Y}`;let le=Ne.get(K);le||(le={key:K,account:Z,displayName:Z,profession:Y,professionList:[Y],totalFightMs:0,skills:new Map},Ne.set(K,le)),le.professionList.includes(Y)||le.professionList.push(Y),le.totalFightMs+=t.durationMS||0;const Fe=c=>{if(!(c!=null&&c.id))return;const{name:d,icon:g}=de(c),P=`s${c.id}`;let he=le.skills.get(P);he||(he={id:P,name:d,icon:g,damage:0,downContribution:0},le.skills.set(P,he)),he.name.startsWith("Skill ")&&!d.startsWith("Skill ")&&(he.name=d),!he.icon&&g&&(he.icon=g),he.damage+=Number(c.totalDamage||0),he.downContribution+=Number(c.downContribution||0)};Q==="total"?(Mt=i.totalDamageDist)==null||Mt.forEach(c=>{c==null||c.forEach(d=>{E(d),Fe(d)})}):(At=i.targetDamageDist)==null||At.forEach(c=>{c==null||c.forEach(d=>{d==null||d.forEach(g=>{E(g),Fe(g)})})}),i.totalDamageTaken&&i.totalDamageTaken.forEach(c=>{c==null||c.forEach(d=>{var Ge,Ue,Se,Ye;if(!(d!=null&&d.id))return;let g=`Skill ${d.id}`;const P=((Ge=t.skillMap)==null?void 0:Ge[`s${d.id}`])||((Ue=t.skillMap)==null?void 0:Ue[`${d.id}`]);let he=P==null?void 0:P.icon;if(P!=null&&P.name&&(g=P.name),g.startsWith("Skill ")){const rn=Cn(g,d.id,t.buffMap);rn&&(g=rn,he=((Ye=(Se=t.buffMap)==null?void 0:Se[`b${d.id}`])==null?void 0:Ye.icon)||he)}ae[d.id]||(ae[d.id]={name:g,icon:he,damage:0,hits:0}),(!ae[d.id].name.startsWith("Skill ")||g.startsWith("Skill "))&&(ae[d.id].name=g),!ae[d.id].icon&&he&&(ae[d.id].icon=he),ae[d.id].damage+=d.totalDamage,ae[d.id].hits+=d.hits})})}),Wn.forEach(i=>{const f=on(i.profession||i.name);f&&(ge[f]=(ge[f]||0)+1)});const J=oo({players:l,targets:a,skillMap:t.skillMap,buffMap:t.buffMap,getPlayerKey:i=>i.account&&i.account!=="Unknown"?i.account:i.name||null}),oe=Xn(t.buffMap);Object.entries(J.playerConditions).forEach(([i,f])=>{const T=se.get(i);T&&Object.entries(f).forEach(([U,M])=>{const p=T.outgoingConditions[U]||{applications:0,damage:0,skills:{},icon:M.icon};p.applications+=Number(M.applications||0),p.damage+=Number(M.damage||0),M.applicationsFromBuffs&&(p.applicationsFromBuffs=(p.applicationsFromBuffs||0)+M.applicationsFromBuffs),M.applicationsFromBuffsActive&&(p.applicationsFromBuffsActive=(p.applicationsFromBuffsActive||0)+M.applicationsFromBuffsActive),Object.entries(M.skills||{}).forEach(([_,v])=>{const I=p.skills[_]||{name:v.name,hits:0,damage:0,icon:v.icon};I.hits+=Number(v.hits||0),I.damage+=Number(v.damage||0),!I.icon&&v.icon&&(I.icon=v.icon),p.skills[_]=I}),!p.icon&&M.icon&&(p.icon=M.icon),T.outgoingConditions[U]=p})}),Object.entries(J.summary).forEach(([i,f])=>{const T=be[i]||{name:f.name||i,icon:f.icon,applications:0,damage:0};T.applications+=Number(f.applications||0),T.damage+=Number(f.damage||0),f.applicationsFromBuffs&&(T.applicationsFromBuffs=(T.applicationsFromBuffs||0)+f.applicationsFromBuffs),f.applicationsFromBuffsActive&&(T.applicationsFromBuffsActive=(T.applicationsFromBuffsActive||0)+f.applicationsFromBuffsActive),!T.icon&&f.icon&&(T.icon=f.icon),be[i]=T}),an.forEach(i=>{const f=i.account&&i.account!=="Unknown"?i.account:i.name||"Unknown",T=se.get(f);!T||!i.totalDamageTaken||i.totalDamageTaken.forEach(U=>U==null?void 0:U.forEach(M=>{var de,E,Z,Y,K,le;if(!(M!=null&&M.id))return;let p=`Skill ${M.id}`;const _=((de=t.skillMap)==null?void 0:de[`s${M.id}`])||((E=t.skillMap)==null?void 0:E[`${M.id}`]);_!=null&&_.name&&(p=_.name);const v=Cn(p,M.id,t.buffMap);if(!v)return;const I=(Y=(Z=t.buffMap)==null?void 0:Z[`b${M.id}`])==null?void 0:Y.name,ce=oe.get(v)||((le=(K=t.buffMap)==null?void 0:K[`b${M.id}`])==null?void 0:le.icon),W=(_==null?void 0:_.icon)||ce;p.startsWith("Skill ")&&(I||v)&&(p=I||v);const N=Number(M.hits??0),V=Number(M.totalDamage??0),L=ve[v]||{name:v,icon:ce,applications:0,damage:0};L.applications+=Number.isFinite(N)?N:0,L.damage+=Number.isFinite(V)?V:0,!L.icon&&ce&&(L.icon=ce),ve[v]=L;const ie=T.incomingConditions[v]||{applications:0,damage:0,skills:{},icon:ce};ie.applications+=Number.isFinite(N)?N:0,ie.damage+=Number.isFinite(V)?V:0;const x=ie.skills[p]||{name:p,hits:0,damage:0,icon:W};x.hits+=Number.isFinite(N)?N:0,x.damage+=Number.isFinite(V)?V:0,!x.icon&&W&&(x.icon=W),ie.skills[p]=x,!ie.icon&&ce&&(ie.icon=ce),T.incomingConditions[v]=ie}))});const Le=t.player_damage_mitigation||t.playerDamageMitigation,Je=Le&&typeof Le=="object"&&Object.keys(Le).length>0;Je&&Object.entries(Le).forEach(([i,f])=>{if(!f||typeof f!="object")return;const T=st(i),U=at(vn,T.account,T);Object.values(f).forEach(M=>{H((M==null?void 0:M.avoided_damage)??(M==null?void 0:M.avoidedDamage))<=0||ct(U.mitigationTotals,M)})});const Nn=t.player_minion_damage_mitigation||t.playerMinionDamageMitigation,Vn=Nn&&typeof Nn=="object"&&Object.keys(Nn).length>0;Vn&&Object.entries(Nn).forEach(([i,f])=>{if(!f||typeof f!="object")return;const T=st(i);Object.entries(f).forEach(([U,M])=>{if(!M||typeof M!="object")return;const p=`${T.account}::${U}`,_=rt(wn,p,{...T,minion:String(U||"Unknown")});Object.values(M).forEach(v=>{ct(_.mitigationTotals,v)})})}),(!Je||!Vn)&&(Je||an.forEach(i=>{const f=(i==null?void 0:i.totalDamageTaken)||[];if(!Array.isArray(f)||f.length===0)return;const T=i.account||i.name||"Unknown",U={account:T,name:i.name||T,profession:on(i.profession||"Unknown")};at(vn,T,U);const M=t.skillMap||{},p=t.buffMap||{},_=Array.isArray(f)?f[0]:null;if(_==null||_.forEach(v=>{if(!(v!=null&&v.id))return;const I=H(v.blocked),ce=H(v.evaded),W=H(v.glance??v.glanced),N=H(v.missed),V=H(v.invulned),L=H(v.interrupted),ie=H(v.hits??v.connectedHits),x=Number(v.id),de=Mn(x,M,p);if(ft(ut,`${T}::${x}`,{totalHits:ie,blocked:I,evaded:ce,glanced:W,missed:N,invulned:V,interrupted:L}),T===An){const E=dn.get(x),Z=Qe(x),Y=Z.hasSkill?Z.hits>0?Z.avg:0:1,K=Z.hasSkill?Z.min||0:1,le=Z.hits>0?W*Y/2+(I+ce+N+V+L)*Y:0,Fe=Z.hits>0?W*K/2+(I+ce+N+V+L)*K:0;Hn.push({logId:e.filePath||e.id||n,skillId:v.id,skillName:de,blocked:I,evaded:ce,glanced:W,missed:N,invulned:V,interrupted:L,totalAvoids:I+ce+W+N+V+L,avg:Y,min:K,enemyHits:(E==null?void 0:E.connectedHits)??0,enemyTotalDmg:(E==null?void 0:E.totalDamage)??0,avoidDmg:le,avoidMinDmg:Fe})}}),T===An){const v=(I,ce)=>{let W=0,N=0,V=0;if(!Array.isArray(I))return{total:W,minTotal:N,hits:V};for(const L of I){if(!(L!=null&&L.id))continue;const ie=H(L.blocked),x=H(L.evaded),de=H(L.glance??L.glanced),E=H(L.missed),Z=H(L.invulned),Y=H(L.interrupted),K=Mn(Number(L.id),m,b),le=ce(Number(L.id),K);(le.hits??0)>0&&(W+=de*le.avg/2+(ie+x+E+Z+Y)*le.avg,N+=de*le.min/2+(ie+x+E+Z+Y)*le.min),V+=H(L.hits??L.connectedHits)}return{total:W,minTotal:N,hits:V}};_n.push({logId:e.filePath||e.id||n,variant:"current_global_name_taken0",...v(_,(I,ce)=>{const W=Qe(I),N=W.hasSkill?W.hits>0?W.avg:0:1,V=W.hasSkill?W.min||0:1;return{avg:N,min:V,hits:W.hits}})})}}),Vn||an.forEach(i=>{const f=(i==null?void 0:i.minions)||[];if(!Array.isArray(f)||f.length===0)return;const T=i.account||i.name||"Unknown",U={account:T,name:i.name||T,profession:on(i.profession||"Unknown")},M=t.skillMap||{},p=t.buffMap||{};f.forEach(_=>{const v=(_==null?void 0:_.totalDamageTakenDist)||[];if(!Array.isArray(v)||v.length===0)return;let I=String((_==null?void 0:_.name)||"Unknown").replace(/^Juvenile\s+/i,"")||"Unknown";I.toUpperCase().includes("UNKNOWN")&&(I="Unknown");const ce=`${T}::${I}`;rt(wn,ce,{...U,minion:I});const W=Array.isArray(v)?v[0]:null;if(W==null||W.forEach(N=>{if(!(N!=null&&N.id))return;const V=H(N.blocked),L=H(N.evaded),ie=H(N.glance??N.glanced),x=H(N.missed),de=H(N.invulned),E=H(N.interrupted),Z=H(N.hits??N.connectedHits),Y=Number(N.id),K=Mn(Y,M,p);if(ft(dt,`${ce}::${Y}`,{totalHits:Z,blocked:V,evaded:L,glanced:ie,missed:x,invulned:de,interrupted:E}),T===An&&I===lt){const le=dn.get(Y),Fe=Qe(Y),Ke=Fe.hasSkill?Fe.hits>0?Fe.avg:0:1,ze=Fe.hasSkill?Fe.min||0:1,Ze=Fe.hits>0?ie*Ke/2+(V+L+x+de+E)*Ke:0,en=Fe.hits>0?ie*ze/2+(V+L+x+de+E)*ze:0;Ln.push({logId:e.filePath||e.id||n,skillId:N.id,skillName:K,blocked:V,evaded:L,glanced:ie,missed:x,invulned:de,interrupted:E,totalAvoids:V+L+ie+x+de+E,avg:Ke,min:ze,enemyHits:(le==null?void 0:le.connectedHits)??0,enemyTotalDmg:(le==null?void 0:le.totalDamage)??0,avoidDmg:Ze,avoidMinDmg:en})}}),T===An&&I===lt){const N=(x,de)=>{let E=0,Z=0,Y=0;if(!Array.isArray(x))return{total:E,minTotal:Z,hits:Y};for(const K of x){if(!(K!=null&&K.id))continue;const le=H(K.blocked),Fe=H(K.evaded),Ke=H(K.glance??K.glanced),ze=H(K.missed),Ze=H(K.invulned),en=H(K.interrupted),Fn=Mn(Number(K.id),m,b),{avg:fn,min:mn}=de(Number(K.id),Fn);H(K.hits??K.connectedHits)>0&&(E+=Ke*fn/2+(le+Fe+ze+Ze+en)*fn,Z+=Ke*mn/2+(le+Fe+ze+Ze+en)*mn),Y+=H(K.hits??K.connectedHits)}return{total:E,minTotal:Z,hits:Y}},V=Array.isArray(v)?v[0]||[]:[],L=Array.isArray(v)?v.flat():[],ie=Array.isArray(_==null?void 0:_.totalDamageTaken)?_.totalDamageTaken[0]||[]:[];Xe.push({logId:e.filePath||e.id||n,variant:"current_global_name_dist0",...N(V,(x,de)=>{const E=Qe(x),Z=E.hasSkill?E.hits>0?E.avg:0:1,Y=E.hasSkill&&E.min||0;return{avg:Z,min:Y}})}),Xe.push({logId:e.filePath||e.id||n,variant:"local_name_dist0",...N(V,(x,de)=>Me(de))}),Xe.push({logId:e.filePath||e.id||n,variant:"local_id_dist0",...N(V,x=>me(x))}),Xe.push({logId:e.filePath||e.id||n,variant:"global_name_alllists",...N(L,(x,de)=>{const E=Qe(x),Z=E.hasSkill?E.hits>0?E.avg:0:1,Y=E.hasSkill&&E.min||0;return{avg:Z,min:Y}})}),Xe.push({logId:e.filePath||e.id||n,variant:"global_name_taken0",...N(ie,(x,de)=>{const E=Qe(x),Z=E.hasSkill?E.hits>0?E.avg:0:1,Y=E.hasSkill&&E.min||0;return{avg:Z,min:Y}})})}})}))}),Ln.length>0&&(console.groupCollapsed("[Mitigation Debug] Ashtonlightstone.9145 / Illusionary Warden"),console.table(Ln),Xe.length>0&&console.table(Xe),console.groupEnd()),Hn.length>0&&(console.groupCollapsed("[Mitigation Debug] Ashtonlightstone.9145 / Player"),console.table(Hn),_n.length>0&&console.table(_n),console.groupEnd());const mt=(e,n)=>{const t=new Map,l=a=>{let m=t.get(a);return m||(m=un(),t.set(a,m)),m};n.forEach((a,m)=>{const b=m.lastIndexOf("::"),F=b>-1?m.slice(0,b):m,B=b>-1?Number(m.slice(b+2)):Number.NaN,me=Number.isFinite(B)?Qe(B):{hasSkill:!1,avg:0,min:0,hits:0};if(!me.hasSkill||me.hits<=0)return;const Me=me.avg,ue=me.min,$e=a.glanced*Me/2+(a.blocked+a.evaded+a.missed+a.invulned+a.interrupted)*Me,Pe=a.glanced*ue/2+(a.blocked+a.evaded+a.missed+a.invulned+a.interrupted)*ue;if($e<=0)return;const ke=l(F);ke.totalHits+=a.totalHits,ke.blocked+=a.blocked,ke.evaded+=a.evaded,ke.glanced+=a.glanced,ke.missed+=a.missed,ke.invulned+=a.invulned,ke.interrupted+=a.interrupted,ke.totalMitigation+=$e,ke.minMitigation+=Pe}),e.forEach((a,m)=>{const b=t.get(m)||un();a.mitigationTotals.totalHits=b.totalHits,a.mitigationTotals.blocked=b.blocked,a.mitigationTotals.evaded=b.evaded,a.mitigationTotals.glanced=b.glanced,a.mitigationTotals.missed=b.missed,a.mitigationTotals.invulned=b.invulned,a.mitigationTotals.interrupted=b.interrupted,a.mitigationTotals.totalMitigation=b.totalMitigation,a.mitigationTotals.minMitigation=b.minMitigation})};mt(vn,ut),mt(wn,dt);const Co=w>0?Math.round(O/w):0,Do=w>0?Math.round($/w):0,To=R>0?(ne/R).toFixed(2):ne>0?"∞":"0.00",ko=Ae>0?(j/Ae).toFixed(2):j>0?"∞":"0.00",gt=(e,n)=>{const l=e.filter(b=>Number.isFinite(b.value)&&(n?b.value>0:b.value>=0)).sort((b,F)=>{const B=n?F.value-b.value:b.value-F.value;return B!==0?B:b.account.localeCompare(F.account)});let a=null,m=0;return l.map((b,F)=>((a===null||b.value!==a)&&(m=F+1,a=b.value),{rank:m,...b}))},On=Array.from(se.values()).map(e=>{const n=Array.from(e.professions).filter(t=>t!=="Unknown");if(e.professionList=n,n.length>0){let t=n[0],l=e.professionTimeMs[t]||0;n.forEach(a=>{const m=e.professionTimeMs[a]||0;m>l&&(l=m,t=a)}),e.profession=t}return{key:e.account,stat:e}}),pt=e=>{const n=se.get(e.account);if(!n){const a=e.professionList.length>0?e.professionList:e.profession?[e.profession]:[];return{...e,professionList:a}}const t=n.professionList&&n.professionList.length>0?n.professionList:Array.from(n.professions||[]).filter(a=>a&&a!=="Unknown"),l=n.profession||e.profession;return{...e,profession:l,professionList:t.length>0?t:l?[l]:[],activeMs:n.defenseActiveMs||n.totalFightMs||e.activeMs}},So=Array.from(vn.values()).map(pt).filter(e=>ho(e.mitigationTotals)).sort((e,n)=>e.account.localeCompare(n.account)),vo=Array.from(wn.values()).map(pt).filter(e=>e.mitigationTotals.totalMitigation>0).sort((e,n)=>{const t=e.account.localeCompare(n.account);return t!==0?t:String(e.minion||"").localeCompare(String(n.minion||""))}),En=(e,n)=>{switch(n){case"downContrib":return e.downContrib;case"barrier":return e.barrier;case"healing":return e.healing;case"dodges":return e.dodges;case"strips":return e.strips;case"cleanses":return e.cleanses;case"cc":return e.cc;case"stability":return e.stab;case"revives":return e.revives;case"dps":return e.dps;case"damage":return e.damage;case"participation":return e.logsJoined;case"closestToTag":return!e.isCommander&&e.distCount>0?e.totalDist/e.distCount:Number.POSITIVE_INFINITY;default:return 0}},Ie=(e,n)=>gt(On.map(({stat:t})=>({account:t.account,profession:t.profession,professionList:t.professionList,value:En(t,e),count:t.logsJoined})),n),Ce={downContrib:Ie("downContrib",!0),barrier:Ie("barrier",!0),healing:Ie("healing",!0),dodges:Ie("dodges",!0),strips:Ie("strips",!0),cleanses:Ie("cleanses",!0),cc:Ie("cc",!0),stability:Ie("stability",!0),revives:Ie("revives",!0),participation:Ie("participation",!0),dps:Ie("dps",!0),damage:Ie("damage",!0),closestToTag:Ie("closestToTag",!1).filter(e=>Number.isFinite(e.value))},wo={downContrib:"downContrib",barrier:"barrier",healing:"healing",dodges:"dodges",strips:"strips",cleanses:"cleanses",cc:"cc",stability:"stability",closestToTag:"closestToTag"},fe=e=>{const n=e==null?void 0:e[0];return{value:(n==null?void 0:n.value)??0,player:(n==null?void 0:n.account)??"-",count:(n==null?void 0:n.count)??0,profession:(n==null?void 0:n.profession)??"Unknown",professionList:(n==null?void 0:n.professionList)??[]}},We={maxDownContrib:fe([]),maxBarrier:fe([]),maxHealing:fe([]),maxDodges:fe([]),maxStrips:fe([]),maxCleanses:fe([]),maxCC:fe([]),maxStab:fe([]),closestToTag:fe([])},Oe={},Mo=(e,n)=>{if(n==="closestToTag")return En(e,n);const t=Math.max(1,(e.totalFightMs||0)/1e3);return En(e,n)/t};Object.values(wo).forEach(e=>{const n=e!=="closestToTag";Oe[e]=gt(On.map(({stat:t})=>({account:t.account,profession:t.profession,professionList:t.professionList,value:Mo(t,e),count:t.logsJoined})),n)}),We.maxDownContrib=fe(Oe.downContrib),We.maxBarrier=fe(Oe.barrier),We.maxHealing=fe(Oe.healing),We.maxDodges=fe(Oe.dodges),We.maxStrips=fe(Oe.strips),We.maxCleanses=fe(Oe.cleanses),We.maxCC=fe(Oe.cc),We.maxStab=fe(Oe.stability),We.closestToTag=fe(Oe.closestToTag);const Ao={maxDownContrib:fe(Ce.downContrib),maxBarrier:fe(Ce.barrier),maxHealing:fe(Ce.healing),maxDodges:fe(Ce.dodges),maxStrips:fe(Ce.strips),maxCleanses:fe(Ce.cleanses),maxCC:fe(Ce.cc),maxStab:fe(Ce.stability),closestToTag:fe(Ce.closestToTag)};let $n={player:"None",account:"None",score:-1,profession:"Unknown",professionList:[],color:"#64748b",topStats:[]},bt,ht,Ct=0;if(z!=null&&z.showMvp){const e={"Down Contribution":"downContribution",Healing:"healing",Cleanses:"cleanses",Strips:"strips",Stability:"stability",CC:"cc",Revives:"revives","Distance to Tag":"distanceToTag",Participation:"participation",Dodging:"dodging",DPS:"dps",Damage:"damage"},n=m=>{const b=e[m];return b?Number(A[b]||0)>0:!1},t=[],l=m=>[...m||[]].filter(b=>n(b==null?void 0:b.name)).sort((b,F)=>F.ratio-b.ratio||b.rank-F.rank||b.name.localeCompare(F.name)).slice(0,3),a=m=>{var F;if(!m)return;const b=l(m.contribs);return{...m,player:m.name,reason:((F=b[0])==null?void 0:F.name)||"Top Performance",topStats:b}};On.forEach(({stat:m})=>{let b=0;const F=[],B=(me,Me,ue,$e,Pe=!0)=>{var De,Re;if(ue<=0)return;const ke=((De=Me[0])==null?void 0:De.value)||0;if(ke&&Number.isFinite(me)&&(Pe?me>0:me<Number.POSITIVE_INFINITY)){const qe=Pe?me/ke:ke/me;b+=qe*ue;const sn=((Re=Me.find(xe=>xe.account===m.account))==null?void 0:Re.rank)||0;F.push({name:$e,ratio:qe,val:me.toLocaleString(),rank:sn})}};B(m.downContrib,Ce.downContrib,A.downContribution,"Down Contribution"),B(m.healing,Ce.healing,A.healing,"Healing"),B(m.cleanses,Ce.cleanses,A.cleanses,"Cleanses"),B(m.strips,Ce.strips,A.strips,"Strips"),B(m.stab,Ce.stability,A.stability,"Stability"),B(m.cc,Ce.cc,A.cc,"CC"),B(m.revives,Ce.revives,A.revives,"Revives"),B(En(m,"closestToTag"),Ce.closestToTag,A.distanceToTag,"Distance to Tag",!1),B(m.logsJoined,Ce.participation,A.participation,"Participation"),B(m.dodges,Ce.dodges,A.dodging,"Dodging"),B(m.dps,Ce.dps,A.dps,"DPS"),B(m.damage,Ce.damage,A.damage,"Damage"),t.push({...m,score:b,contribs:F.filter(me=>n(me.name))})}),t.sort((m,b)=>b.score-m.score),t[0]&&t[0].score>0&&($n=a(t[0])||$n),bt=a(t[1]),ht=a(t[2]),Ct=t.length>0?t.reduce((m,b)=>m+b.score,0)/t.length:0}const Eo=Object.values(te).sort((e,n)=>{const t=D==="downContribution"?e.downContribution:e.damage;return(D==="downContribution"?n.downContribution:n.damage)-t}).slice(0,25),No=Object.values(ae).sort((e,n)=>n.damage-e.damage).slice(0,25),Fo=e=>{const n=String(e).replace(/^Detailed\s*WvW\s*-\s*/i,"").replace(/^World\s*vs\s*World\s*-\s*/i,"").replace(/^WvW\s*-\s*/i,"").trim(),t=n.match(/^(Red|Blue|Green)\s+(?:Alpine|Desert)?\s*Borderlands$/i);return t?`${t[1]} Borderlands`:n||"Unknown"},Dt=(e,n)=>Fo((e==null?void 0:e.zone)||(e==null?void 0:e.mapName)||(e==null?void 0:e.map)||(e==null?void 0:e.location)||(e==null?void 0:e.fightName)||(n==null?void 0:n.fightName)||(n==null?void 0:n.encounterName)||"Unknown"),Bo=(e,n)=>{const t=(n==null?void 0:n.permalink)||(e==null?void 0:e.permalink);if(typeof t=="string"&&t.trim().length>0)return t.trim();const l=e==null?void 0:e.uploadLinks;if(!Array.isArray(l))return"";for(const a of l){if(typeof a=="string"&&a.trim().length>0)return a.trim();if(a&&typeof a=="object"){const m=a.permalink||a.link||a.url||a.reportLink;if(typeof m=="string"&&m.trim().length>0)return m.trim()}}return""},Rn={};S.forEach(e=>{const n=Dt(e==null?void 0:e.details,e);Rn[n]=(Rn[n]||0)+1});const Io=Object.entries(Rn).map(([e,n])=>{const t=String(e).trim(),l=/eternal battlegrounds|^ebg$/i.test(t);let a="#64748b";return l?a="#ffffff":/red/i.test(t)?a="#ef4444":/blue/i.test(t)?a="#3b82f6":/green/i.test(t)&&(a="#22c55e"),{name:e,value:n,color:a}}).sort((e,n)=>n.value-e.value),{boonTables:Po}=Pt(S),Uo=S.map((e,n)=>{var l,a;const t=((l=e.details)==null?void 0:l.players)||[];return{index:n+1,label:`Log ${n+1}`,timestamp:nn(e.details,e),squadCount:t.filter(m=>!m.notInSquad).length,friendlyCount:t.length,enemies:((a=e.details)==null?void 0:a.targets).filter(m=>!m.isFake).length}}).sort((e,n)=>e.timestamp-n.timestamp),qn={};Array.from(se.values()).forEach(e=>{e.profession&&e.profession!=="Unknown"&&(qn[e.profession]=(qn[e.profession]||0)+1)});const Lo=Object.entries(qn).map(([e,n])=>({name:e,value:n,color:Zn(e)})).sort((e,n)=>n.value-e.value),xn={};Object.keys(ge).length===0&&S.forEach(e=>{var n,t;(t=(n=e.details)==null?void 0:n.targets)==null||t.forEach(l=>{if(l.isFake)return;const a=l.profession&&l.profession!=="Unknown"?l.profession:l.name||l.id||"Unknown",m=on(a);xn[m]=(xn[m]||0)+1})});const Ho=Object.keys(ge).length>0?ge:xn,_o=Object.entries(Ho).map(([e,n])=>({name:e,value:n,color:Zn(e)})).sort((e,n)=>n.value-e.value),Oo=S.map((e,n)=>({log:e,originalIndex:n})).sort((e,n)=>nn(e.log.details,e.log)-nn(n.log.details,n.log)).map(({log:e},n)=>{const t=e.details;if(!t)return null;const l=t.players||[],a=l.filter(u=>!u.notInSquad),m=l.filter(u=>u.notInSquad),b=t.targets||[],F=b.filter(u=>!u.isFake),B=a.reduce((u,X)=>{var q,re;return u+(((re=(q=X.dpsAll)==null?void 0:q[0])==null?void 0:re.damage)||0)},0),me=a.reduce((u,X)=>{var q,re;return u+(((re=(q=X.defenses)==null?void 0:q[0])==null?void 0:re.damageTaken)||0)},0),{enemyDeaths:Me,enemyDownsDeaths:ue}=Te(t),$e=pe(t),Pe=nn(t,e),ke=Dt(t,e),De={red:0,green:0,blue:0},Re=u=>{const X=Number(u);return Number.isFinite(X)?X:0},qe=u=>{if(!u||typeof u!="object")return;const X=u.teamID??u.teamId??u.team??u.teamColor??u.team_color;if(X!=null)return X;const q=Object.keys(u).find(re=>/^team/i.test(re));return q?u[q]:void 0},sn=(u,X)=>{if(u==null)return null;if(typeof u=="string"){const q=u.toLowerCase();return q.includes("red")?"red":q.includes("green")?"green":q.includes("blue")?"blue":q==="r"?"red":q==="g"?"green":q==="b"?"blue":null}if(typeof u=="number")if(X==="zeroBased"){if(u===0)return"red";if(u===1)return"green";if(u===2)return"blue"}else{if(u===1)return"red";if(u===2)return"green";if(u===3)return"blue"}return null},xe=(u,X)=>{const q={};return u.forEach(re=>{const J=X(re),oe=on(J);oe&&(q[oe]=(q[oe]||0)+1)}),q},jn=xe(a,u=>(u==null?void 0:u.profession)||(u==null?void 0:u.name)),an=xe(m,u=>(u==null?void 0:u.profession)||(u==null?void 0:u.name)),Wn=xe(F,u=>(u==null?void 0:u.profession)||(u==null?void 0:u.name)||(u==null?void 0:u.id));if(t.teamCounts&&typeof t.teamCounts=="object"){const u=t.teamCounts;De.red=Re(u.red??u.r??u[0]??u[1]),De.green=Re(u.green??u.g??u[1]??u[2]),De.blue=Re(u.blue??u.b??u[2]??u[3])}else{const u=[];b.forEach(J=>{if(J!=null&&J.isFake)return;const oe=qe(J);oe!=null&&u.push(oe)}),l.forEach(J=>{if(!(J!=null&&J.notInSquad))return;const oe=qe(J);oe!=null&&u.push(oe)}),u.length===0&&l.forEach(J=>{const oe=qe(J);oe!=null&&u.push(oe)});const X=new Set;u.forEach(J=>{typeof J=="number"&&X.add(J)});const q=X.has(0)?"zeroBased":X.has(3)?"oneBased":"zeroBased";if(u.forEach(J=>{const oe=sn(J,q);oe&&(De[oe]+=1)}),De.red+De.green+De.blue===0&&u.length>0){const J=new Map;u.forEach(Le=>{const Je=String(Le);J.set(Je,(J.get(Je)||0)+1)});const oe=Array.from(J.values()).sort((Le,Je)=>Je-Le);De.red=oe[0]||0,De.green=oe[1]||0,De.blue=oe[2]||0}De.red+De.green+De.blue===0&&(De.red=Math.max(F.length,l.filter(J=>J==null?void 0:J.notInSquad).length))}return{id:e.filePath||`fight-${n}`,label:e.encounterName||`Fight ${n+1}`,permalink:Bo(t,e),timestamp:Pe,mapName:ke,duration:fo(t.durationMS),isWin:$e,squadCount:a.length,allyCount:m.length,enemyCount:F.length,teamCounts:De,alliesDown:a.reduce((u,X)=>{var q,re;return u+(((re=(q=X.defenses)==null?void 0:q[0])==null?void 0:re.downCount)||0)},0),alliesDead:a.reduce((u,X)=>{var q,re;return u+(((re=(q=X.defenses)==null?void 0:q[0])==null?void 0:re.deadCount)||0)},0),alliesRevived:a.reduce((u,X)=>{var q,re;return Number(((re=(q=X.statsAll)==null?void 0:q[0])==null?void 0:re.saved)||0)>0?u+1:u},0),rallies:0,enemyDeaths:Me,enemyDowns:Math.max(0,ue-Me),totalOutgoingDamage:B,totalIncomingDamage:me,incomingBarrierAbsorbed:a.reduce((u,X)=>{var q,re;return u+(((re=(q=X.defenses)==null?void 0:q[0])==null?void 0:re.damageBarrier)||0)},0),outgoingBarrierAbsorbed:a.reduce((u,X)=>{var J;const q=(J=X.extBarrierStats)==null?void 0:J.outgoingBarrier;if(!Array.isArray(q))return u;let re=0;return q.forEach(oe=>{if(Array.isArray(oe)){oe.forEach(Le=>{re+=Number((Le==null?void 0:Le.barrier)||0)});return}re+=Number((oe==null?void 0:oe.barrier)||0)}),u+re},0),squadClassCountsFight:jn,allyClassCountsFight:an,enemyClassCounts:Wn}}).filter(Boolean),$o=Array.from(je.entries()).map(([e,n])=>{const t=Ve.get(e)||{},l=Array.from(n.values()).map(a=>{var Me;const m=Array.from(a.professions||[]).filter(ue=>ue&&ue!=="Unknown");let b=a.profession||"Unknown";if(m.length>0){b=m[0];let ue=((Me=a.professionTimeMs)==null?void 0:Me[b])||0;m.forEach($e=>{var ke;const Pe=((ke=a.professionTimeMs)==null?void 0:ke[$e])||0;Pe>ue&&(ue=Pe,b=$e)})}const F=a.durationMs||0,B=a.totalMs/1e3,me=F>0?a.totalMs/F:0;return{account:a.account,profession:b,professionList:m,total:B,perSecond:me,duration:F/1e3}}).filter(a=>a.total>0||a.perSecond>0);return{id:e,name:t.name||e,icon:t.icon,rows:l}}).filter(e=>e.rows.length>0),Ro=Array.from(Ne.values()).map(e=>{const n=Array.from(e.skills.values()).sort((l,a)=>a.damage-l.damage),t=n.reduce((l,a)=>(l[a.id]=a,l),{});return{key:e.key,account:e.account,displayName:e.displayName,profession:e.profession,professionList:e.professionList,totalFightMs:e.totalFightMs,skills:n,skillMap:t}}).sort((e,n)=>e.displayName.localeCompare(n.displayName));return{total:w,wins:y,losses:C,avgSquadSize:Co,avgEnemies:Do,squadKDR:To,enemyKDR:ko,totalSquadKills:ne,totalSquadDeaths:R,totalEnemyKills:j,totalEnemyDeaths:Ae,leaderboards:Ce,...Ao,outgoingConditionSummary:Object.values(be).sort((e,n)=>n.damage-e.damage),incomingConditionSummary:Object.values(ve).sort((e,n)=>n.damage-e.damage),outgoingConditionPlayers:Array.from(se.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,conditions:e.outgoingConditions})),incomingConditionPlayers:Array.from(se.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,conditions:e.incomingConditions})),topSkills:Eo,topIncomingSkills:No,playerSkillBreakdowns:Ro,topSkillsMetric:D,mapData:Io,timelineData:Uo,boonTables:Po,offensePlayers:Array.from(se.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,offenseTotals:e.offenseTotals,offenseRateWeights:e.offenseRateWeights,totalFightMs:e.totalFightMs})),defensePlayers:Array.from(se.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,defenseTotals:e.defenseTotals,activeMs:e.defenseActiveMs})),damageMitigationPlayers:So,damageMitigationMinions:vo,supportPlayers:Array.from(se.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,supportTotals:e.supportTotals,activeMs:e.supportActiveMs})),healingPlayers:Array.from(se.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,healingTotals:e.healingTotals,activeMs:e.healingActiveMs})),mvp:$n,silver:bt,bronze:ht,squadClassData:Lo,enemyClassData:_o,fightBreakdown:Oo,specialTables:$o,topStatsPerSecond:We,topStatsLeaderboardsPerSecond:Oe,avgMvpScore:Ct}})(),Be=(()=>{const ee=new Map,Q=new Map,D=[],w=new Map,y=new Map;S.forEach(O=>{const $=O.details;if(!$)return;const R=$.skillMap||{},ne=$.fightName||"Log",Ae=nn($,O)||Date.now(),j={id:O.filePath||O.id||ne,label:ne,timestamp:Ae,skillEntries:{},playerActiveSeconds:{},durationSeconds:$.durationMS?$.durationMS/1e3:0};($.players||[]).forEach(pe=>{if(pe.notInSquad)return;const se=pe.account||pe.name||"Unknown",Ee=pe.profession||"Unknown",te=`${se}|${Ee}`;let ae=Q.get(te);ae||(ae={key:te,account:se,displayName:se,profession:Ee,professionList:[Ee],logs:0,totalActiveSeconds:0,skillTotals:{}},Q.set(te,ae)),ae.logs++;const Ne=(Array.isArray(pe.activeTimes)?pe.activeTimes[0]:0)/1e3;ae.totalActiveSeconds=(ae.totalActiveSeconds||0)+Ne,j.playerActiveSeconds[te]=Ne,(pe.rotation||[]).forEach(be=>{var Tn,kn,Sn;if(!(be!=null&&be.id))return;const ve=((Tn=be.skills)==null?void 0:Tn.length)||0;if(ve<=0)return;const ge=`s${be.id}`,Ve=((kn=R[ge])==null?void 0:kn.name)||`Skill ${be.id}`,je=(Sn=R[ge])==null?void 0:Sn.icon;ae.skillTotals[ge]=(ae.skillTotals[ge]||0)+ve,ee.set(ge,(ee.get(ge)||0)+ve),w.set(ge,Ve),je&&!y.has(ge)&&y.set(ge,je),j.skillEntries[ge]||(j.skillEntries[ge]={name:Ve,icon:je,players:{}}),!j.skillEntries[ge].icon&&je&&(j.skillEntries[ge].icon=je),j.skillEntries[ge].players[te]=(j.skillEntries[ge].players[te]||0)+ve})}),D.push(j)});const C=Array.from(ee.entries()).map(([O,$])=>({id:O,name:w.get(O)||O,total:$,icon:y.get(O)})).sort((O,$)=>$.total-O.total);return{logRecords:D,players:Array.from(Q.values()),skillOptions:C,resUtilitySkills:[]}})();return{validLogs:S,stats:we,skillUsageData:Be}};let _e=null,tn=!1,et=null,nt=0,tt=0,Pn=null;const ot=o=>{if(!o||typeof o!="object")return o;const s=(h,k)=>{const S={};return k.forEach(z=>{h&&Object.prototype.hasOwnProperty.call(h,z)&&(S[z]=h[z])}),S},r=s(o,["players","targets","durationMS","uploadTime","timeStart","timeStartStd","timeEnd","timeEndStd","fightName","success","teamCounts","combatReplayMetaData","skillMap","buffMap","encounterDuration","player_damage_mitigation","player_minion_damage_mitigation","playerDamageMitigation","playerMinionDamageMitigation"]);return Array.isArray(r.players)&&(r.players=r.players.map(h=>s(h,["name","display_name","character_name","profession","elite_spec","group","dpsAll","statsAll","dpsTargets","statsTargets","defenses","support","rotation","extHealingStats","extBarrierStats","squadBuffVolumes","selfBuffs","groupBuffs","squadBuffs","selfBuffsActive","groupBuffsActive","squadBuffsActive","buffUptimes","totalDamageDist","targetDamageDist","totalDamageTaken","totalDamageTakenDist","minions","combatReplayData","hasCommanderTag","notInSquad","account","activeTimes"]))),Array.isArray(r.targets)&&(r.targets=r.targets.map(h=>s(h,["id","name","isFake","dpsAll","statsAll","defenses","totalHealth","healthPercentBurned","enemyPlayer","totalDamageDist"]))),r},po=o=>{if(!o||typeof o!="object")return o;const s={...o};return o.details?s.details=ot(o.details):s.details=ot(o),s},it=()=>{if(!tn||!_e)return;tn=!1,nt+=1;const o=Pn;Pn=null;const s=go(_e);self.postMessage({type:"result",result:s,computeId:nt,logCount:_e.logs.length,token:tt,completedAt:Date.now(),flushId:o})},Un=()=>{et===null&&(et=setInterval(()=>{it()},5e3))};self.onmessage=o=>{var r,h,k,S;const s=o.data;if((s==null?void 0:s.type)==="reset"){_e={logs:[]},typeof s.token=="number"&&(tt=s.token),tn=!0,Un();return}if((s==null?void 0:s.type)==="settings"){_e={logs:(_e==null?void 0:_e.logs)||[],precomputedStats:(r=s.payload)==null?void 0:r.precomputedStats,mvpWeights:(h=s.payload)==null?void 0:h.mvpWeights,statsViewSettings:(k=s.payload)==null?void 0:k.statsViewSettings,disruptionMethod:(S=s.payload)==null?void 0:S.disruptionMethod},tn=!0,Un();return}if((s==null?void 0:s.type)==="log"){_e||(_e={logs:[]}),_e.logs.push(po(s.payload)),tn=!0,Un();return}(s==null?void 0:s.type)==="flush"&&(typeof s.flushId=="number"&&(Pn=s.flushId),tn=!0,it())}})();
